<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Влияние детализации модели на FPS в WebAR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    #ui {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(0,0,0,0.6); color: white; padding: 10px; border-radius: 10px;
    }
    button, select { margin: 5px; padding: 10px; font-size: 16px; }
    #info { margin-top: 10px; font-size: 18px; }
  </style>
</head>
<body>
  <div id="ui">
    <button id="startAR">Запустить AR</button><br>
    <select id="modelSelect">
      <option value="low">Low-poly (низкая детализация)</option>
      <option value="mid">Mid-poly (средняя)</option>
      <option value="high">High-poly (высокая)</option>
    </select>
    <div id="info">FPS: —<br>Полигонов: —</div>
  </div>

  <script type="module">
    import * as THREE from './libs/three.module.js';
    import { GLTFLoader } from './libs/GLTFLoader.js';
    import { ARButton } from './libs/ARButton.js';
    import Stats from './libs/stats.module.js';

    let camera, scene, renderer;
    let model = null;
    let stats;
    let currentModelName = 'low';
    let fpsArray = [];
    let logInterval;

    const modelPolyCount = { low: 0, mid: 0, high: 0 }; // заполнишь вручную после проверки

    init();
    animate();

    function init() {
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // Свет
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.5);
      scene.add(light);

      // FPS счётчик
      stats = new Stats();
      stats.dom.style.position = 'absolute';
      stats.dom.style.top = '10px';
      stats.dom.style.left = 'auto';
      stats.dom.style.right = '10px';
      document.body.appendChild(stats.dom);

      // Кнопка AR
      const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
      document.getElementById('startAR').replaceWith(arButton);

      // Выбор модели
      document.getElementById('modelSelect').addEventListener('change', (e) => {
        currentModelName = e.target.value;
        loadModel();
      });

      loadModel();

      window.addEventListener('resize', onWindowResize);
    }

    function loadModel() {
      if (model) scene.remove(model);

      const loader = new GLTFLoader();
      loader.load(`./models/${currentModelName}.glb`, (gltf) => {
        model = gltf.scene;

        // Автомасштаб и центрирование
        const box = new THREE.Box3().setFromObject(model);
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());
        model.position.sub(center);
        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 1.5 / maxDim;
        model.scale.setScalar(scale);

        model.position.y = -0.5;
        model.position.z = -1.5;

        scene.add(model);

        // Считаем полигоны (примерно)
        let polyCount = 0;
        model.traverse((child) => {
          if (child.isMesh && child.geometry.index) {
            polyCount += child.geometry.index.count / 3;
          } else if (child.isMesh && child.geometry.attributes.position) {
            polyCount += child.geometry.attributes.position.count / 3;
          }
        });
        modelPolyCount[currentModelName] = Math.round(polyCount);

        document.getElementById('info').innerHTML = `
          FPS: —<br>
          Полигонов: ${modelPolyCount[currentModelName]}
        `;
      });
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render(time) {
      stats.update();

      // Логируем FPS каждую секунду
      const fps = Math.round(stats.fps || 0);
      document.getElementById('info').innerHTML = `
        FPS: ${fps}<br>
        Полигонов: ${modelPolyCount[currentModelName]}
      `;

      renderer.render(scene, camera);
    }
  </script>
</body>
</html>