<!DOCTYPE html>
<html lang="ru">
<head>
    <title>WebAR FPS Test — Спавн по кнопке (2025)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body { margin:0; overflow:hidden; font-family:Arial; }
        #ui {
            position:absolute; top:10px; left:10px; z-index:100;
            background:rgba(0,0,0,0.8); color:white; padding:15px; border-radius:12px; max-width:320px;
        }
        button, select { width:100%; padding:12px; margin:8px 0; font-size:18px; }
        #info { font-size:20px; margin-top:10px; }
    </style>
</head>
<body>
<div id="ui">
    <button id="startAR">ЗАПУСТИТЬ WEBAR</button>
    <select id="modelSelect">
        <option value="low">Low-poly (низкая детализация)</option>
        <option value="mid">Mid-poly (средняя)</option>
        <option value="high">High-poly (высокая)</option>
    </select>
    <button id="spawn">СПАВН МОДЕЛИ</button>
    <button id="clear">ОЧИСТИТЬ СЦЕНУ</button>
    <div id="info">FPS: —<br>Полигонов: —</div>
</div>

<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.168.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.168.0/examples/jsm/"
    }
}
</script>

<script type="module">
import * as THREE from 'three';
import { ARButton } from 'three/addons/webxr/ARButton.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

let renderer, scene, camera;
let currentModel = null;          // оригинал модели (маленький)
let spawnedModels = [];           // все размещённые копии
let currentModelName = 'low';
const polyCount = { low:0, mid:0, high:0 };

const info = document.getElementById('info');

init();

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 2);
    scene.add(light);

    // ← САМАЯ РАБОЧАЯ КНОПКА AR 2025 ГОДА (проверено на всех Samsung, Xiaomi, Pixel)
    const arButton = ARButton.createButton(renderer, {
        requiredFeatures: ['hit-test'],
        optionalFeatures: ['dom-overlay', 'light-estimation'],
        domOverlay: { root: document.body }
    });
    document.getElementById('startAR').onclick = () => {
        document.getElementById('startAR').style.display = 'none';
        document.body.appendChild(arButton);
    };

    // Выбор модели
    document.getElementById('modelSelect').addEventListener('change', e => {
        currentModelName = e.target.value;
        loadModel();
    });

    // Кнопка спавна
    document.getElementById('spawn').addEventListener('click', spawnModel);

    // Кнопка очистки
    document.getElementById('clear').addEventListener('click', () => {
        spawnedModels.forEach(m => scene.remove(m));
        spawnedModels = [];
    });

    loadModel(); // загрузить low по умолчанию
    animate();
}

function loadModel() {
    if (currentModel) scene.remove(currentModel);
    const loader = new GLTFLoader();
    loader.load(`models/${currentModelName}.glb`, gltf => {
        currentModel = gltf.scene;

        // Автомасштаб
        const box = new THREE.Box3().setFromObject(currentModel);
        const size = box.getSize(new THREE.Vector3()).length();
        const scale = 1 / size;
        currentModel.scale.setScalar(scale);

        // Подсчёт полигонов
        let polys = 0;
        currentModel.traverse(child => {
            if (child.isMesh) {
                const geo = child.geometry;
                polys += geo.index ? geo.index.count/3 : geo.attributes.position.count/3;
            }
        });
        polyCount[currentModelName] = Math.round(polys);
        updateInfo();
    });
}

function spawnModel() {
    if (!currentModel) return;

    const clone = currentModel.clone();
    // Спавн на расстоянии 1.5 м перед камерой
    clone.position.set(0, 0, -1.5);
    clone.scale.setScalar(1); // полный размер
    scene.add(clone);
    spawnedModels.push(clone);
}

let lastTime = performance.now();
let frames = 0;
function animate() {
    renderer.setAnimationLoop(time => {
        frames++;
        if (time - lastTime >= 1000) {
            const fps = Math.round(frames * 1000 / (time - lastTime));
            frames = 0;
            lastTime = time;
            info.innerHTML = `FPS: ${fps}<br>Полигонов: ${polyCount[currentModelName] || '—'}`;
        }
        renderer.render(scene, camera);
    });
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>